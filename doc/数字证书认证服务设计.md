# 数字证书服务设计

- [数字证书服务设计](#%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1)
  - [1 参考资料](#1-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99)
  - [2 术语](#2-%E6%9C%AF%E8%AF%AD)
  - [3 总体设计原则](#3-%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99)
  - [4 要求](#4-%E8%A6%81%E6%B1%82)
    - [4.1 功能要求](#41-%E5%8A%9F%E8%83%BD%E8%A6%81%E6%B1%82)
    - [4.2 性能要求](#42-%E6%80%A7%E8%83%BD%E8%A6%81%E6%B1%82)
    - [4.3 管理员配置要求](#43-%E7%AE%A1%E7%90%86%E5%91%98%E9%85%8D%E7%BD%AE%E8%A6%81%E6%B1%82)
    - [4.4 初始化要求](#44-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%A6%81%E6%B1%82)
    - [4.5 网络划分要求(可选)](#45-%E7%BD%91%E7%BB%9C%E5%88%92%E5%88%86%E8%A6%81%E6%B1%82%E5%8F%AF%E9%80%89)
    - [4.6 密钥安全要求](#46-%E5%AF%86%E9%92%A5%E5%AE%89%E5%85%A8%E8%A6%81%E6%B1%82)
      - [4.6.1 基本要求](#461-%E5%9F%BA%E6%9C%AC%E8%A6%81%E6%B1%82)
      - [4.6.2 根 CA 密钥安全性要求](#462-%E6%A0%B9-ca-%E5%AF%86%E9%92%A5%E5%AE%89%E5%85%A8%E6%80%A7%E8%A6%81%E6%B1%82)
      - [4.6.3 管理员证书密钥要求(可选)](#463-%E7%AE%A1%E7%90%86%E5%91%98%E8%AF%81%E4%B9%A6%E5%AF%86%E9%92%A5%E8%A6%81%E6%B1%82%E5%8F%AF%E9%80%89)
      - [4.6.4 证书管理安全要求(可选)](#464-%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86%E5%AE%89%E5%85%A8%E8%A6%81%E6%B1%82%E5%8F%AF%E9%80%89)
      - [4.6.5 安全审计要求](#465-%E5%AE%89%E5%85%A8%E5%AE%A1%E8%AE%A1%E8%A6%81%E6%B1%82)
      - [4.6.5.1 功能模块调用日志](#4651-%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97%E8%B0%83%E7%94%A8%E6%97%A5%E5%BF%97)
      - [4.6.5.2 CA 系统管理员审计(可选)](#4652-ca-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E5%91%98%E5%AE%A1%E8%AE%A1%E5%8F%AF%E9%80%89)
      - [4.6.5.3 CA 业务操作员审计(可选)](#4653-ca-%E4%B8%9A%E5%8A%A1%E6%93%8D%E4%BD%9C%E5%91%98%E5%AE%A1%E8%AE%A1%E5%8F%AF%E9%80%89)
      - [4.6.5.4 RA 业务操作员审计(可选)](#4654-ra-%E4%B8%9A%E5%8A%A1%E6%93%8D%E4%BD%9C%E5%91%98%E5%AE%A1%E8%AE%A1%E5%8F%AF%E9%80%89)
  - [5 各个模块功能](#5-%E5%90%84%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD)
    - [5.1 用户注册管理系统](#51-%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F)
    - [5.2 证书/证书撤销列表的生成签发系统](#52-%E8%AF%81%E4%B9%A6%E8%AF%81%E4%B9%A6%E6%92%A4%E9%94%80%E5%88%97%E8%A1%A8%E7%9A%84%E7%94%9F%E6%88%90%E7%AD%BE%E5%8F%91%E7%B3%BB%E7%BB%9F)
    - [5.3 证书/证书撤销列表的存储发布系统](#53-%E8%AF%81%E4%B9%A6%E8%AF%81%E4%B9%A6%E6%92%A4%E9%94%80%E5%88%97%E8%A1%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%8F%91%E5%B8%83%E7%B3%BB%E7%BB%9F)
      - [5.3.1 证书/证书撤销列表的存储发布系统功能](#531-%E8%AF%81%E4%B9%A6%E8%AF%81%E4%B9%A6%E6%92%A4%E9%94%80%E5%88%97%E8%A1%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%8F%91%E5%B8%83%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD)
      - [5.3.2 证书/证书撤销列表的存储发布系统结构](#532-%E8%AF%81%E4%B9%A6%E8%AF%81%E4%B9%A6%E6%92%A4%E9%94%80%E5%88%97%E8%A1%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%8F%91%E5%B8%83%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84)
    - [5.4 证书状态查询系统](#54-%E8%AF%81%E4%B9%A6%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F)
      - [5.4.1 证书状态查询系统功能](#541-%E8%AF%81%E4%B9%A6%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD)
      - [5.4.2 证书状态查询系统结构](#542-%E8%AF%81%E4%B9%A6%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84)
    - [5.5 证书管理系统](#55-%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F)
    - [5.6 安全管理系统(可选)](#56-%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E5%8F%AF%E9%80%89)

## 1 参考资料

- GMT 0034-2014 基于SM2密码算法的证书认证系统密码及其相关安全技术规范
- GMT 0016-2012 智能密码钥匙密码应用接口规范

## 2 术语

| 术语 | 定义 | 缩写 | 详细信息 |
| --- | --- | --- | --- |
| 密钥管理中心 | key management center | KMC | - |
| 证书认证机构 | certificate authority | CA | 对数字证书进行全生命周期管理的实体，也称为电子认证服务机构或认证中心 |
| 证书注册机构 | registration authority | RA | 受理数字证书的申请、更新、恢复和注销等业务的实体 |

## 3 总体设计原则

- 模块之间的通信采用基于身份验证机制的安全通信协议
- 密码运算必须在密码设备完成
- 产生的审计日志文件采用统一的格式传递和存储

## 4 要求

### 4.1 功能要求

- CA 提供两种审核模式：
  - 人工审核
  - 自动审核

### 4.2 性能要求

- CA 系统的性能要求包括：
  - 系统对用户接口采用标准的 HTTP/HTTPS/LDAP/OCSP 协议，确保各种用户能够使用本系统服务
  - 各模块的状态信息保存在配置文件和数据库内部，保证系统的部署方便性和配置方便性，当系统需改变配置时无需中断系统的服务(可选)
  - 各模块的功能可通过配置文件进行控制，系统可根据不同的需求进行设置
  - 某一功能模块可有多个实例，且多个实例可允许在一台或多台计算机上
  - 系统应有冗余设计，保证系统的不间断运行(可选)

### 4.3 管理员配置要求

CA 应设置下列管理和操作人员

| 管理员类型 | 描述 | 权限 |
| --- | --- | --- |
| CA 超级管理员 | 负责 CA 系统的策略设置，设置各子系统的业务管理员并对其管理的业务范围进行授权 | 增删改 CA 业务管理员账号 |
| CA 业务管理员 | 负责 CA 系统的某个子系统的业务管理，设置本子系统的业务操作员并对其的操作权限进行授权 | 增删改 CA 业务操作员账号 |
| CA 业务操作员 | 按其权限进行具体的业务操作 | 管理证书模板、配置证书策略、对系统进行配置，如配置主机加密服务器参数、目录服务器、CA 系统参数、RA 系统参数等；增删改 RA 业务管理员和 RA 审计员账号 |
| CA 审计管理员 | 负责删除审计员并进行管理 | 增删改 CA 审计员账号 |
| CA 审计员 | 负责对涉及系统安全的事件和各类管理和操作人员的行为进行审计和监督 | 查询 CA 系统日志、查询审计 CA 操作记录 |
| RA 业务管理员 | - | 增删改 RA 业务操作员账号 |
| RA 业务操作员 | - | 对证书申请的录入；对证书更新申请、密钥恢复申请的录入；审核证书申请、撤销审核；证书的下载、制作；证书查询；审核证书更新请求和密钥恢复请求；录入和审核工作不能由同一人兼任 |
| RA 审计员 | - | 查询 RA 系统日志、查询审计 RA 操作记录 |
| 安全管理员 | - | 全面负责系统的安全工作 |

- 上述各类人员使用证书进行登录(可选)
  - 超级管理员和审计管理员的证书应在 CA 系统进行初始化并同时产生
- 暂时只支持使用用户名和密码登录

### 4.4 初始化要求

CA 的初始化过程必须完成下列工作：

- 产生本 CA 的机构密钥对
- 使用 (3,5) 门限秘密共享机制将密码对中的私钥交由 5 个独立的分管者保管(可选)
- CA 的签名密钥进行自签名
- CA 签发 CA 服务器证书
- CA 签发 RA 服务器证书(可选)
- CA 签发超级管理员和审计管理员证书(可选)
- CA 签发其他审计员、管理员和操作员证书(可选)

### 4.5 网络划分要求(可选)

CA 系统的计算机网络原则上划分为 4 个部分：

- 公共部分：CA 用户所在的网络，所有用户将通过该网络访问 CA
- 服务部分：为外部用户提供域名解析功能，并负责内部系统对外部邮件的收发功能；包括系统的各种 Web 服务器和从目录服务器，是外部用户访问内部功能的忌口，为用户提供访问界面
- 管理部分：仅供 CA 的工作人员使用的网络
- 核心部分：包括各种核心应用、数据库和密码设备等在内的实现系统功能的安全网络

当 RA 采用浏览器/服务器模式时，可将服务部分和管理部分放在同一网段

### 4.6 密钥安全要求

#### 4.6.1 基本要求

- 密钥的生成和使用必须在硬件密码设备完成
- 密钥的生成和使用必须有安全可靠的管理机制(可选)
- 存在于硬件密码设备之外的所有密钥必须加密
- 密钥必须有安全可靠的备份恢复机制(可选)
- 对密码设备操作必须由多个操作员实施(可选)

#### 4.6.2 根 CA 密钥安全性要求

除了 4.6.1 的基本要求，还应满足下列要求：

- 根 CA 密钥的产生：
  - CA 系统的根密钥由硬件密码设备生成并存档在该密码设备中
  - 生成根 CA 密钥时，应先选定分管者。选定的分管者应分别用自己输入的口令保护分管的密钥份额，分管的密钥份额应存放在智能 IC 卡或智能密码钥匙中，智能 IC 卡或智能密码钥匙也应备份，并安全存放(可选)
  - 根 CA 密钥的生成过程必须进行记录
- 根 CA 密钥的恢复(可选)
  - 恢复时，由 5 个分管者中任意 3 个将各自分管的份额输入密码设备，在密码设备中恢复根 CA 密钥
- 根 CA 密钥的更新(可选)
  - 需重新生成根 CA 密钥，过程同根 CA 密钥的生成
- 根 CA 密钥的废除(可选)
  - 废除与更新同步
- 根 CA 密钥的销毁(可选)
  - 销毁应与备份的根 CA 密钥一同销毁，由密码主管部门授权的机构实施

#### 4.6.3 管理员证书密钥要求(可选)

- 管理员包括超级管理员、审计管理员、审计员、业务管理员和业务操作员等。管理员证书对应的公私密钥对必须使用硬件来产生，并将私钥存储在不可读出的硬件（如智能密码钥匙）中
- 管理员证书密钥的安全性应满足下列要求：
  - 管理员证书密钥的产生和使用必须在证书载体中完成
  - 密钥的生成和使用必须有安全可靠的管理机制
  - 管理员的口令长度为 8 个字节以上
  - 管理员的账号要和普通用户账号严格分类管理

#### 4.6.4 证书管理安全要求(可选)

证书的管理安全应满足下列要求：

- 验证证书申请者的身份
- 防止非法签发和越权签发证书，通过审批的证书申请必须提交给 CA，由 CA 签发与申请者身份相符的证书
- 保证证书管理的可审计性，对于证书的任何处理都应作日志记录，通过对日志的分析，可对证书事件进行审计和跟踪

#### 4.6.5 安全审计要求

CA 系统在运行过程中涉及大量功能模块之间的相互调用，及各种管理员的操作。对这些调用和操作需要以日志的形式进行记载，以便用于系统错误分析、风险分析和安全审计等。

#### 4.6.5.1 功能模块调用日志

对于模块相互之间的功能调用，各模块应记录如下数据：

- 调用请求的接收时间
- 调用请求的来源网络地址
- 调用请求发起者的身份
- 调用请求的内容
- 处理结果

#### 4.6.5.2 CA 系统管理员审计(可选)

CA 系统管理员的下列操作应被记录：

- 根 CA 证书加载
- CA 证书加载
- CRL 加载
- CRL 更新
- 系统配置
- 权限分配

#### 4.6.5.3 CA 业务操作员审计(可选)

CA 业务操作员审计的下列操作应被记录：

- 证书请求批准
- 证书请求拒绝
- 证书请求分配
- 证书注销

#### 4.6.5.4 RA 业务操作员审计(可选)

RA 业务操作员审计的下列操作应被记录：

- 证书请求批准
- 证书请求拒绝
- 证书请求分配
- 证书注销

## 5 各个模块功能

### 5.1 用户注册管理系统

用户注册管理系统功能包括：

- 用户信息的录入：
  - 用户申请信息包括签发证书所需的信息，还包括用于验证用户身份的信息，这些信息存放在用户注册管理系统的数据库
  - 用户注册管理系统应能够批量处理外部系统生成的、以电子文档方式存储的用户信息(可选)
- 用户信息的审核：提取用户的申请信息，审核用户的真实身份
  - 审核通过后，将证书签发所需信息提交给签发系统
- 用户证书下载：
  - 签发系统为用户签发证书后，用户可以下载用户证书，并将证书写入指定的用户证书载体，然后分发给用户(可选)
- 安全审计：对用户注册管理系统的管理人员、操作人员的操作日志进行查询、统计及报表打印等(可选)
- 安全管理：对用户注册管理系统系统的登录进行安全控制访问，并对用户信息数据库进行管理和备份(可选)
- 多级审核：(可选)
  - 可根据需要采用分级部署的模式，对不同种类和等级的证书，可由不同级别的用户注册管理系统进行审核
  - 应能根据需求支持多级注册管理系统的简历和多级审核模式
- 具有并行处理能力

### 5.2 证书/证书撤销列表的生成签发系统

证书/证书撤销列表的生成签发系统功能包括：

- 证书生成与签发：
  - 根据接收的请求信息，从数据库读取用户信息进行核对，根据拟签发的证书类型向密钥管理中心申请加密密钥对，生成用户的签名证书和加密证书
  - 签发的证书和及加密证书的私钥通过证书管理系统下传给申请者
  - 将签发完成的证书发布到目录服务器和数据库
  - 根据系统的配置和管理策略，不同种类或用途的证书可采用不同的签名密钥
- 证书更新：
  - 更新 CA 证书及用户证书
- 证书撤销列表生成与签发：
  - 接收注销信息，验证注销信息中的签名，然后签发 CRL，将签发后的注销列表发布到数据库或目录服务器
  - 签发证书撤销列表的签名密钥可与签发证书的签名密钥相同或不同
- 安全审计(可选)：
  - 查询证书/证书撤销列表生成与签发系统的管理人员、操作人员的操作日志，进行统计及报表打印
- 安全管理：
  - 对证书/证书撤销列表生成与签发系统的登录进行安全访问控制(可选)
  - 对证书/证书撤销列表数据库进行管理和备份(可选)
  - 设置管理员、操作员，并为这些人员申请和下载数字证书(可选)
  - 配置不同的密码设备
  - 配置不同的证书模板：
    - 不同的证书种类由不同的证书模板确定
    - 证书模板包括相应种类证书的基本项和证书的扩展项
  - 配置证书撤销列表发布策略：包括自动/人工发布模式选择、发布时间间隔
  - 更新 CA 密钥(可选)
  - 服务器安全配置：包括服务器可接受的主机访问列表(可选)
  - 配置数据库系统：数据源的选择，数据库连接的用户名和口令设置
- 具有并行处理能力
- 密码设备：
  - 完成签名及验证工作，并负责与其他系统通信过程中的密码运算，CA 的签名密钥保存在密码设备
  - 保证所使用的密钥不能以明文形式读出密码设备

### 5.3 证书/证书撤销列表的存储发布系统

#### 5.3.1 证书/证书撤销列表的存储发布系统功能

- 证书/证书撤销列表存储
- 证书/证书撤销列表发布
- 安全审计(可选)：
  - 查询证书/证书撤销列表存储发布系统的管理人员、操作人员的操作日志，进行统计及报表打印
- 安全管理(可选)：
  - 对证书/证书撤销列表存储发布系统的登录进行访问控制
  - 定期对数据库和目录服务器进行管理和备份
- 数据一致性检验：对数据库和目录服务器中的数据进行一致性检验

#### 5.3.2 证书/证书撤销列表的存储发布系统结构

- 证书的存储和发布必须采用数据库和/或目录服务器
- 数据库：存放证书、CRL、用户的其他信息
- 目录服务器(可选)：
  - 采用主从结构
  - 签发完成的数据直接写入主目录服务器，然后由目录服务器的主从映射功能自动映射到从目录服务器
  - 主从目录服务器通常配置不同等级的安全区域
  - 用户只能访问从目录服务器

### 5.4 证书状态查询系统

#### 5.4.1 证书状态查询系统功能

- 为用户及应用系统提供证书状态查询服务
- 查询方式可采用：
  - CRL 查询：用户或应用系统利用证书中标识的 CRL 地址，查询并下载 CRL 到本地，进行证书状态的检验
  - 在线证书状态查询：用户或应用系统利用 OCSP 协议，在线实时查询证书的状态，查询结果经过签名后返回给请求者，进行证书状态的检验

#### 5.4.2 证书状态查询系统结构

- 证书状态数据库/OCSP 服务器：接收用户及应用系统的证书状态查询请求，根据请求信息中的证书序列号，从证书状态数据库中查询证书的状态，返回查询结果给请求者
- 密码设备：验证请求信息中的签名，并对查询结果进行签名
- 安全管理：
  - OCSP 服务器的配置：定义可接受的访问控制信息以及查询的证书状态数据库的地址
  - 启动/停止查询服务
  - 配置可接受的用户请求数量(可选)
- 安全审计：查询证书状态查询系统中的安全审计日志，进行统计与打印等(可选)

### 5.5 证书管理系统

- 证书管理系统是证书认证系统的综合信息控制和调度服务系统。它接收用户的各种请求信息，并将请求信息提交给相应的子系统
- 证书管理系统由不同的处理模块组成，这些模块可采用分布式的结构，以增强系统处理能力

### 5.6 安全管理系统(可选)

- 对涉及系统安全的行为、人员、时间的记录进行跟踪、统计和分析
- 日志记录的主要内容包括：操作员姓名、操作项目、操作起始时间、操作终止时间、证书序列号和操作结果
- 日志管理的主要内容包括：
  - 日志参数设置：设置日志保存的最大规模和日志备份的目录
  - 日志查询：查询操作员、操作事件信息
  - 日志备份：当日志保存到日志参数设置的最大规模时，将保存的日志备份
  - 日志处理：对日志记录的正常业务流量和各类事件进行分类整理
  - 证据管理：对证据数据进行审计、统计和记录